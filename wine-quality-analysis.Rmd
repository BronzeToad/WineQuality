---
title: "Wine Quality Analysis"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    theme: united
  pdf_document:
    toc: yes
editor_options:
  markdown:
    wrap: 80
chunk_output_type: inline
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
    fig.width=12, 
    fig.height=8, 
    fig.path='figures/',
    echo=FALSE, 
    warning=FALSE, 
    message=FALSE,
    include=TRUE
    )
```

```{r library, include=FALSE}
library(ggplot2)
library(stringr)
library(dplyr)
library(tidyr)
library(gridExtra)
library(corrplot)
library(car)
library(ggsci)
library(ggcorrplot)
```

```{r set_working_directory, include=FALSE}
setwd('~/Documents/WGU/Udacity NanoDegree/Data Analysis with R')
```

```{r import_data, include=FALSE}
# import data
winesWhite <- read.csv(
    file = 'data/wine-quality-white.csv',
    stringsAsFactors = FALSE, 
    strip.white = TRUE,
    sep = ','
    )

winesRed <- read.csv(
    file = 'data/wine-quality-red.csv',
    stringsAsFactors = FALSE, 
    strip.white = TRUE,
    sep = ','
    )
```

<br>

******
# Initial Data Cleaning

<br>

shape of white wines dataframe

```{r white_wine_shape}
dim(winesWhite)
```

<br>

shape of red wines dataframe

```{r red_wine_shape}
dim(winesRed)
```

<br>

structure of white wines dataframe

```{r white_wine_structure}
str(winesWhite)
```

<br>

structure of red wines dataframe

```{r winesRed_structure}
str(winesRed)
```

<br>

The white and red wine datasets have the same shape and structure.
We can combine them into a single dataset to make analysis easier.

```{r clean_and_combine, echo=TRUE}
# drop the 'X' column - it's not necessary for this analysis
winesRed <- winesRed %>% 
    select(-X)
winesWhite <- winesWhite %>% 
    select(-X)

# add a column to indicate from which dataset the record originated
winesRed$type <- 'red'
winesWhite$type <- 'white'

# combine red and white wine datasets
winesAll <- rbind(winesRed, winesWhite)
```

<br>

I'm going to adjust the column names to better conform to R best practices.

```{r colnames}
colnames(winesAll)[1] <- 'fixed_acidity'
colnames(winesAll)[2] <- 'volatile_acidity'
colnames(winesAll)[3] <- 'citric_acid'
colnames(winesAll)[4] <- 'residual_sugar'
colnames(winesAll)[6] <- 'free_sulfur_dioxide'
colnames(winesAll)[7] <- 'total_sulfur_dioxide'

colnames(winesAll)
```

<br>

Next, we should convert the type and quality variables to factors. 
Then we can review the structure of our combined dataset.

```{r factors}
# type as factor
winesAll$type <- factor(winesAll$type)

# quality as factor
#qLevels <- c('3', '4', '5', '6', '7', '8', '9')
qLevels <- c('0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10')
winesAll$quality_factor <- factor(winesAll$quality, levels = qLevels)

# structure
str(winesAll)
```

<br>

******
# Univariate Plots

First I'll create a summary and some plots for each individual variable.

<br>

## Histogram/Density Plots + Summary

<br>

### Quality

```{r quality_histogram, warning=FALSE}
ggplot(winesAll, aes(quality_factor)) +
    geom_histogram(stat = 'count', aes(fill = type)) +
    facet_wrap(~type) +
    scale_x_discrete(limits = c(qLevels))
```

<br>

For both red and white wines, the average quality is around 5 or 6. 
Let's check the mean to see how they differ.

```{r quality_mean}
winesAll %>% 
    group_by(type) %>% 
    summarize(count = n(), mean = mean(quality, na.rm = TRUE))
```

<br>

The distribution for wine quality observed makes it apparent that this is a 
human-selected, subjective measure.

<br>

```{r quality_tally}
winesAll %>% 
    group_by(quality_factor) %>% 
    summarize(n = n()) %>%
    mutate(freq = n / sum(n))
```

Despite 'quality' being a score between 0 and 10, there are no observations 
below 3 or above 9. 
Only 3.0% of the observations had a quality score of 8 or 9, and there were 
only 3.7% with a score of 3 or 4. 
It's interesting that the vast majority (93.2%) of quality scores 
are 5, 6, or 7. 

<br>

In the next section, I'll be creating a summary and two combined 
histogram/density plots for each variable in the wines dataset 
(one for continuous scale and one for log10). 
To avoid using repetitive code, I'll write a function to handle the summary 
and plots.

```{r histogram_density_function, echo=TRUE}
PLOT_HISTOGRAM_DENSITY <- function(strVar, limStart=99, limEnd=99)
{
    # create vector based on string variable input
    winesVector <- unlist(winesAll[c(strVar)], use.names = FALSE)
    
    # adjust default limit start
    if (limStart == 99) {
        limStart <- min(winesVector)
    }
    
    # adjust default limit end
    if (limEnd == 99) {
        limEnd <- max(winesVector)
    }
    
    # summary
    summaryOut <- summary(winesVector)
    
    # calculate number of class intervals (Sturge's Rule)
    k <- 1 + 3.322 * log(6497)
    
    # calculate bin width - scale_x_continuous
    r <- max(winesVector)- min(winesVector)
    bw <- r / k

    # histogram - scale_x_continuous
    contHist <- ggplot(winesAll, aes(winesVector)) +
        geom_histogram(binwidth = bw, aes(fill = type)) +
        facet_wrap(~type) +
        labs(title = 'scale_x_continuous', x = strVar)
    
    # density plot - scale_x_continuous
    contDens <- ggplot(winesAll, aes(winesVector, fill = type)) +
        geom_density(alpha = 0.5) +
        scale_x_continuous(limits = c(limStart, limEnd)) +
        labs(title = 'scale_x_continuous', x = strVar)
    
    # calculate bin width - scale_x_log10
    mx <- max(log10(winesVector))
    mn <- min(log10(winesVector))
    bw_log <- (mx - mn) / k
    
    # set bw_log to static number if result is infinite number
    if ( is.infinite(bw_log) ) {
        bw_log <- 0.069
    }
    
    # histogram - scale_x_log10
    logHist <- ggplot(winesAll, aes(winesVector)) +
        geom_histogram(binwidth = bw_log, aes(fill = type)) +
        facet_wrap(~type) +
        scale_x_log10() +
        labs(title = 'scale_x_log10', x = strVar)
    
    # density plot - scale_x_log10
    logDens <- ggplot(winesAll, aes(winesVector, fill = type)) +
        geom_density(alpha = 0.5) +
        scale_x_log10() +
        labs(title = 'scale_x_log10', x = strVar)

    # print summary and plots
    grid.arrange(contHist, contDens)
    grid.arrange(logHist, logDens)
    return(summaryOut)
}
```

<br>

I'm including additional plots for scale_x_log10 because many of these 
variables are not normally distributed. 
Plotting them on a log10 scale will often, but not necessarily, 
result in a normally distributed plot.

<br>

I'm guessing that the two sulfur dioxide (SO2) variables could be more 
informative if compared.  
Before I create these plots, I'm going to create another new variable that 
represents the ratio of free SO2 to total S02 - percent_free_SO2.

```{r create_percent_free_so2, echo=TRUE}
winesAll$percent_free_SO2 <- winesAll$free_sulfur_dioxide / winesAll$total_sulfur_dioxide
```

<br>

### Fixed Acidity

```{r fixed_acidity, warning=FALSE}
# summary + histogram/density plots
PLOT_HISTOGRAM_DENSITY('fixed_acidity', 4, 12)
```

<br>

### Volatile Acidity

```{r volatile_acidity, warning=FALSE}
# summary + histogram/density plots
PLOT_HISTOGRAM_DENSITY('volatile_acidity', 0, 1)
```

<br>

### Citric Acid

```{r citric_acid, warning=FALSE}
# summary + histogram/density plots
PLOT_HISTOGRAM_DENSITY('citric_acid', 0, 1)
```

<br>

### Residual Sugar

```{r residual_sugar, warning=FALSE}
# histogram/density plots
PLOT_HISTOGRAM_DENSITY('residual_sugar', 0, 8)
```

<br>

### Chlorides

```{r chlorides, warning=FALSE}
# histogram/density plots
PLOT_HISTOGRAM_DENSITY('chlorides', 0, 0.15)
```

<br>

### Free Sulfur Dioxide

```{r free_sulfur_dioxide, warning=FALSE}
# histogram/density plots
PLOT_HISTOGRAM_DENSITY('free_sulfur_dioxide', 0, 100)
```

<br>

### Total Sulfur Dioxide

```{r total_sulfur_dioxide, warning=FALSE}
# histogram/density plots
PLOT_HISTOGRAM_DENSITY('total_sulfur_dioxide', 0, 250)
```

<br>

### Percent Free Sulfur Dioxide

```{r percent_free_SO2}
# histogram/density plots
PLOT_HISTOGRAM_DENSITY('percent_free_SO2', 0, 1)
```

<br>

### Density

```{r density, warning=FALSE}
# histogram/density plots
PLOT_HISTOGRAM_DENSITY('density', 0.98, 1.01)
```

<br>

### pH

```{r pH, warning=FALSE}
# histogram/density plots
PLOT_HISTOGRAM_DENSITY('pH', 2.5, 4)
```

<br>

### Sulphates

```{r sulphates, warning=FALSE}
# histogram/density plots
PLOT_HISTOGRAM_DENSITY('sulphates', 0.25, 1.25)
```

<br>

### Alcohol

```{r alcohol, warning=FALSE}
# histogram/density plots
PLOT_HISTOGRAM_DENSITY('alcohol', 8, 14)
```

<br>

## Boxplots

Next, I'll create a boxplot for each variable so I can quickly visualize mean 
values, the distribution of each variable within the dataset, 
and any skewed data or outliers.
Just like I did for the previous section, I'll leverage a function to reduce 
redundant code.

```{r boxplot_function, echo=TRUE}
PLOT_BOXPLOT <- function(strVar, limStart=99, limEnd=99)
{
    # create vector based on string variable input
    winesVector <- unlist(winesAll[c(strVar)], use.names = FALSE)
    
    # adjust default limit start
    if (limStart == 99) {
        limStart <- min(winesVector)
    }
    
    # adjust default limit end
    if (limEnd == 99) {
        limEnd <- max(winesVector)
    }

    # set plot title
    plotTitle <- paste0(strVar, ' by wine type')

    # create boxplot
    ggplot(winesAll, aes(x = type, y = winesVector, fill = type)) +
        geom_boxplot() +
        scale_y_continuous(limits = c(limStart, limEnd)) +
        labs(title = plotTitle, y = strVar)
}
```

<br>

```{r boxplots, warning=FALSE}
# fixed_acidity
PLOT_BOXPLOT('fixed_acidity', 4, 12)

# volatile_acidity
PLOT_BOXPLOT('volatile_acidity', 0, 1)

# citric_acid
PLOT_BOXPLOT('citric_acid', 0, 1)

# residual_sugar
PLOT_BOXPLOT('residual_sugar', 0, 8)

# chlorides
PLOT_BOXPLOT('chlorides', 0, 0.15)

# free_sulfur_dioxide
PLOT_BOXPLOT('free_sulfur_dioxide', 0, 100)

# total_sulfur_dioxide
PLOT_BOXPLOT('total_sulfur_dioxide', 0, 250)

# percent_free_SO2
PLOT_BOXPLOT('percent_free_SO2', 0, 1)

# density
PLOT_BOXPLOT('density', 0.98, 1.01)

# pH
PLOT_BOXPLOT('pH', 2.5, 4)

# sulphates
PLOT_BOXPLOT('sulphates', 0.25, 1.25)

# alcohol
PLOT_BOXPLOT('alcohol', 8, 14)

```

<br>

******
# Univariate Analysis

<br>

### What is the structure of your datasets?

There are 1,599 observations in the red wines dataset and 4,898 observations in 
the white wines dataset.
Each dataset originally had 12 variables (fixed_acidity, volatile_acidity, 
citric_acid, residual_sugar, chlorides, free_sulfur_dioxide, 
total_sulfur_dioxide, density, pH, sulphates, alcohol, and quality).  

<br>

**Variable Descriptions** [3]  

1. fixed acidity (tartaric acid - g / dm^3)
    + most acids involved with wine or fixed or nonvolatile
2. volatile acidity (acetic acid - g / dm^3)
    + the amount of acetic acid in wine, which at too high of levels can lead 
    to an unpleasant, vinegar taste
3. citric acid (g / dm^3)
    + found in small quantities, citric acid can add 'freshness' and flavor to 
    wines
4. residual sugar (g / dm^3)
    + the amount of sugar remaining after fermentation stops
    + it's rare to find wines with less than 1 gram/liter and wines with 
    greater than 45 grams/liter are considered sweet
5. chlorides (sodium chloride - g / dm^3)
    + the amount of salt in the wine
6. free sulfur dioxide (mg / dm^3)
    + the free form of SO2 exists in equilibrium between molecular SO2 
    (as a dissolved gas) and bisulfite ion
    + it prevents microbial growth and the oxidation of wine
7. total sulfur dioxide (mg / dm^3)
    + amount of free and bound forms of S02
    + in low concentrations, SO2 is mostly undetectable in wine, but at free 
    SO2 concentrations over 50 ppm, SO2 becomes evident in the nose and taste 
    of wine
8. density (g / cm^3)
    + the density of water is close to that of water depending on the percent 
    alcohol and sugar content
9. pH
    + describes how acidic or basic a wine is on a scale from 0 (very acidic) 
    to 14 (very basic)
    + most wines are between 3-4 on the pH scale
10. sulphates (potassium sulphate - g / dm3)
    + a wine additive which can contribute to sulfur dioxide gas (S02) levels
    + acts as an antimicrobial and antioxidant
11. alcohol (% by volume)
    + the percent alcohol content of the wine
12. quality (score between 0 and 10)
    + based on sensory data, and is highly subjective

<br>

**Initial Observations**  

- Red wines have a higher volatile acidity, higher pH, and more chlorides than 
white wines.
- White wines have more free and total sulfur dioxide than red wines, but red 
wines have a slightly higher percentage of free sulfur dioxide when compared 
to white wines.
- Red wines are more dense and have more sulphates (on average) than white 
wines.
- There is no immediately obvious disparity between the two types of wine when 
comparing alcohol content.

<br>

### What is/are the main feature(s) of interest in your dataset?

The primary features of interest in this dataset is quality. 
I'd like to find out what variables are most predictive of the perceived 
quality of wine. 

<br>

### What other features in the dataset do you think will help support your 
investigation into your feature(s) of interest?

I suspect alcohol and acidity are both big factors in quality, but I will 
explore the other variables to find out.

<br>

### Did you create any new variables from existing variables in the dataset?

I created a new variable (type) as a factor when combining the two datasets 
so white and red wines could be distinguished during analysis.  
I also created quality_factor, which is a factorized version of the quality 
variable. 
This variable will make it possible to group, fill, and facet_wrap by the 
quality score on my plots in the remainder of this document.  
Finally, I created a new variable that represents the ratio of free SO2 to 
total S02 - percent_free_SO2.

<br>

### Of the variables you investigated, were there any unusual distributions? 
Did you perform any operations on the data to tidy, adjust, or change the form 
of the data? If so, why did you do this?

Many of the variables have unusual distributions, which is why I included a 
log10 version of the histogram/density plot for each variable. 
Plotting them on a log10 scale will often, but not necessarily, result in a 
more normal distribution. 
I could have done this just for those that had abnormal distributions, but 
including the log10 plot in my function makes it easy to quickly review both 
continuous and log10 versions for each variable.  

Also, I adjusted the quality factor variable to include scores that are not in 
the dataset (0, 1, 2, 10). 
Even though no records received those scores, I think it's important to display 
them because the quality measure is on a 0-10 scale.  

I also had to include a section in my PLOT_HISTOGRAM_DENSITY function to 
account for infinite binwidth values in the log10 plots which, obviously, do 
not plot correctly. 
If the result of my binwidth calculation was 'Inf', I set bw_log to a default 
binwidth defined in my function.

<br>

**Abnormal Distributions**  

- volatile acidity
    + the distribution for white wine is skewed to the left, and red wine has a 
    bimodal distribution
    + plotting on a log10 scale brought the plots closer to a normal 
    distribution, but red wine is still bimodal
- citric acid
    + the distribution for red wine is fairly flat, and there are peaks in the 
    distribution of white wine at 0.25, 0.5, and 0.75
    + plotting on a log10 scale created a more normal distribution, but the 
    peaks observed in white wines are still present
- residual sugar
    + after ploting on a log10 scale, a bimodal distribution is observed in the 
    white wine sample
- free sulfur dioxide
    + the distribution for both wine types is right-skewed, but this is more 
    pronounced in the red wine sample
    + plotting on a log10 scale brings the plots closer to normal distribution, 
    but the white wine is now a bit left-skewed while the red wine sample has 
    several peaks and valleys
- sulphates
    + the distribution for both types of wine skew to the right
    + plotting on a log10 scale results in a fairly typical normal distribution 
    for both types
- alcohol
    + the distribution for both wine types is wide and right-skewed
    + plotting on a log10 scale doesn't do much to fix this result

<br>

******
# Bivariate Plots

In this section, I'll examine the relationship between variables with 
correlation and scatter plots.

<br>

## Correlation Plots

Again, I'll leverage a user-defined-function to create these plots.

```{r corr_matrix_function, echo=TRUE}
PLOT_CORR_MATRIX <- function(subType='all')
{
    # create subset of just variables that will be tested
    winesSubset <- winesAll %>% 
        select(-c(quality_factor, free_sulfur_dioxide, total_sulfur_dioxide))
    
    # set title to default
    plotTitle <- 'corr matrix - all wines'
    
    # white wine only
    if (subType == 'white') {
        winesSubset <- winesSubset %>% filter(type == 'white')
        plotTitle <- 'corr matrix - white wines'
    }
    
    # red wine only
    if (subType == 'red') {
        winesSubset <- winesSubset %>% filter(type == 'red')
        plotTitle <- 'corr matrix - red wines'
    }
    
    # remove type
    winesSubset <- winesSubset %>% select(-type)
    
    # adjust column names so they fit on a chart
    colnames(winesSubset) <- c('fix.acdty', 'vol.acdty', 'citric.acd', 
                               'res.sgr', 'chlorides', 'density', 'pH', 
                               'sulphates', 'alcohol', 'quality', '%.fr.SO2')
    
    # create correlation matrix
    corrMatrix <- cor(winesSubset, method = 'spearman')

    # plot correlation matrix
    corrplot.mixed(corrMatrix, order = 'AOE', tl.col = 'black', tl.cex = 0.8, 
                   number.cex = 1.1, title = plotTitle, mar=c(0,0,1,0))
}
```


<br>

### All Wines

```{r corr_matrix_all}
# correlation matrix for all wines
PLOT_CORR_MATRIX()
```

For the all wines dataset, there is a moderate positive correlation between 
quality and alcohol. 
Also, there is a moderate negative correlation between quality and three 
variables: volatile acidity, chlorides, and density.

<br>

Next I'll examine the white and red wine datasets individually to see if these 
patterns are consistent between types of wine.

<br>

### Red Wines & White Wines

```{r corr_matrix_red_white}
# correlation matrix for white wines
PLOT_CORR_MATRIX(subType = 'white')

# correlation matrix for red wines
PLOT_CORR_MATRIX(subType = 'red')
```

For both red and white wine, there is a moderate, positive, correlation between 
quality and alcohol. 
Also, a moderate, positive, correlation exists between quality and sulphates 
for red wine.  

<br>

## Scatter Plots

After reviewing the correlation plots, there are a few relationships I want to 
take a closer look at.

<br>

### Quality vs. Volatile Acidity

```{r scatter_q_vol_acdty, warning=FALSE}
ggplot(winesAll, aes(x = quality, y  = volatile_acidity)) +
    geom_point()
```

The first iteration of my scatter plot is not very informative, but that can 
be fixed by adding jitter, plotting the mean, and grouping by wine type.

```{r scatter_plot_function, echo=TRUE}
PLOT_SCATTERPLOT <- function(strVar, limStart=99, limEnd=99)
{
    # create vector based on string variable input
    winesVector <- unlist(winesAll[c(strVar)], use.names = FALSE)
    
    # adjust default limit start
    if (limStart == 99) {
        limStart <- min(winesVector)
    }
    
    # adjust default limit end
    if (limEnd == 99) {
        limEnd <- max(winesVector)
    }

    # create scatter plot
    ggplot(winesAll, aes(x = quality, y = winesVector, color = type)) +
        geom_jitter(alpha = 0.5) +
        geom_line(stat = 'summary', fun = mean, color = 'gray30') +
        facet_wrap(~type) +
        scale_x_continuous(breaks = c(3,4,5,6,7,8)) +
        scale_y_continuous(limits = c(limStart, limEnd)) +
        labs(y = strVar)
}
```

<br>

### Quality vs. Volatile Acidity II

```{r scatter_q_vol.acdty, warning=FALSE}
PLOT_SCATTERPLOT('volatile_acidity', 0, 1)
```

A negative correlation exists between quality and volatile acidity. 
This variable is more impactful to the perceived quality of red wine than it 
is for white wine.

<br>

### Quality vs. Chlorides

```{r scatter_q_chlorides, warning=FALSE}
PLOT_SCATTERPLOT('chlorides', 0, 0.15)
```

A negative correlation exists between quality and chlorides for both types of 
wine.  

<br>

### Quality vs. Density

```{r scatter_q_density, warning=FALSE}
PLOT_SCATTERPLOT('density', 0.98, 1.01)
```

A negative correlation exists between quality and density. 
This variable is more impactful to the perceived quality of white wine than it 
is for red wine.

<br>

### Quality vs. Sulphates

```{r scatter_q_sulphates, warning=FALSE}
PLOT_SCATTERPLOT('sulphates', 0.25, 1.25)
```

A positive correlation exists between quality and sulphates for red wine. 
However, no such correlation is observed for white wine.

<br>

### Quality vs. Alcohol

```{r scatter_quality_alchl, warning=FALSE}
PLOT_SCATTERPLOT('alcohol', 8, 14)
```

A positive correlation exists between quality and alcohol content for both 
white and red wine. 
Interestingly, this is only true for wines rated at a quality of 5 or higher.

<br>

******
# Bivariate Analysis

<br>

### Talk about some of the relationships you observed in this part of the 
investigation. How did the feature(s) of interest vary with other features in 
the dataset?

My primary variables of interest were quality and alcohol. 
The relationship between alcohol content and perceived quality is interesting.
There is a positive correlation between quality and alcohol for all three 
datasets:

- all wines: 0.45
- white wine: 0.44
- red wine: 0.48

However, this is only true for wines rated at a quality of 5 or higher. 
For wines rated at a quality lower than 5, the inverse is true 
(although much less significant).

<br>

### Did you observe any interesting relationships between the other features 
(not the main feature(s) of interest)?

I explored a few other variables' relationship to quality.  

Volatile acidity and quality have a clear negative correlation for all three 
datasets, but this variable is more impactful to the perceived quality of red 
wine than it is to that of white wine:

- all wines: -0.26
- white wine: -0.20
- red wine: -0.38

A negative correlation exists between quality and chlorides for all three 
datasets:

- all wines: -0.30
- white wine: -0.31
- red wine: -0.19

Density and quality are negatively correlated, but this variable is more 
impactful to the perceived quality of white wine than it is to that of red wine:

- all wines: -0.32
- white wine: -0.35
- red wine: -0.18

A moderate positive correlation exists between quality and sulphates for 
red wine. 
However, no such correlation is observed for white wine.

- white wine: 0.03
- red wine: 0.38

<br>

### What was the strongest relationship you found?

The strongest relationship observed was a negative relationship between 
density and alcohol for both the combined dataset (-0.70) and the white wines 
subset (-0.82). 
For the red wine subset, the strongest relationship observed was a negative 
relationship between fixed acidity and pH (-0.71).  

Neither of these relationships are particularly surprising or interesting.  

More interestingly is the relationships between quality and the other variables. 
For the combined datasets, and for both subsets (white and red), the strongest 
relationship perceived quality has with any other variable is a positive one 
with alcohol content.

- all wines: 0.45
- white wine: 0.44
- red wine: 0.48

<br>

******
# Multivariate Plots

<br>                

## Multi-Variable Density Plots

<br>

```{r density_by_fill_function, echo=TRUE}
PLOT_DENSITY_BY_FILL <- function(strVar, strGrp, limStart=99, limEnd=99)
{
    # create vector based on string variable input
    winesVector <- unlist(winesAll[c(strVar)], use.names = FALSE)
    groupVector <- unlist(winesAll[c(strGrp)], use.names = FALSE)
    
    # adjust default limit start
    if (limStart == 99) {
        limStart <- min(winesVector)
    }
    
    # adjust default limit end
    if (limEnd == 99) {
        limEnd <- max(winesVector)
    }
    
    # set plot title
    plotTitle <- paste0('density by ', strGrp, ' - ', strVar)
    
    # create density plot
    ggplot(data = winesAll, aes(winesVector, fill = groupVector)) +
        geom_density(alpha = 0.25) +
        scale_x_continuous(limits = c(limStart, limEnd)) +
        labs(title = plotTitle, x = strVar, fill = strGrp)
    
}
```

<br>

### Density by Quality Factor

<br>

```{r density_by_q_factor, warning=FALSE}
# density by quality_factor - alcohol
PLOT_DENSITY_BY_FILL('alcohol', 'quality_factor', 8, 14)
```

<br>

It's a bit hard to see what's going here. 
Let's group the qualities together to make it easier to analyze. 
I'll bucket quality scores into three groups: low(3, 4, 5); avg(6); and 
high(7, 8, 9).

```{r def_quality_groups, echo=TRUE, warning=FALSE}
# create quality group
winesAll <- winesAll %>%
    mutate(quality_group = case_when(
        quality < 6  ~ 'low',
        quality > 6  ~ 'high',
        TRUE         ~ 'avg'
    ))

# convert to factor for plots
qGroups <- c('low', 'avg', 'high')
winesAll$quality_group <- factor(winesAll$quality_group, levels = qGroups)
```

<br>

### Density by Quality Groups

<br>

```{r density_by_q_group, warning=FALSE}
# density by quality_group - alcohol
PLOT_DENSITY_BY_FILL('alcohol', 'quality_group', 8, 14)

# density by quality_group - sulphates
PLOT_DENSITY_BY_FILL('sulphates', 'quality_group', 0.25, 1.25)

# density by quality_group - density
PLOT_DENSITY_BY_FILL('density', 'quality_group', 0.98, 1.01)

# density by quality_group - volatile_acidity
PLOT_DENSITY_BY_FILL('volatile_acidity', 'quality_group', 0, 1)

# density by quality_group - chlorides
PLOT_DENSITY_BY_FILL('chlorides', 'quality_group', 0, 0.15)
```

<br>

## Scatter Plot Matrix

Before I move on, I'm going to take a look at a plot I don't like using - 
the scatter plot matrix. 
It's extremely popular, and I'd like to demonstrate why I avoid using it.

```{r scatter_plot_matrix, warning=FALSE}
winesSubset <- winesAll %>% 
    select(c(quality, alcohol, chlorides, volatile_acidity, density, sulphates))

scatterplotMatrix(winesSubset)
rm(winesSubset)
```

<br>

While this kind of plot does look at multiple variables in different ways all 
in one visualization, it's difficult to analyze when you have more than a 
few variables. 
In my example, I paired the dataset down to 6 variables, and still the plot 
is a jumbled mess. 
It's much more productive to step through the variables and relationships 
in a thoughtful way; deciding what visualization would best fit your the goals 
of your analysis.

<br>
    
******
# Multivariate Analysis

<br>

### Talk about some of the relationships you observed in this part of the 
investigation. Were there features that strengthened each other in terms of 
looking at your feature(s) of interest?

In this section, I narrowed my focus and used density plots to analyze the 
relationships between a few key variables and quality. To do this, I created a 
new variable called quality_group that is comprised of three factors: low, avg, 
and high. Each group has roughly the same number of observations.  

I decided to use this methodology after observing that there was an increase 
in perceived quality, but only for those wines rated at a quality of 
5 or higher.

<br>

### Were there any interesting or surprising interactions between features?

The most interesting interaction between variables is definitely the 
correlation between alcohol and quality. A surprising relationship was between 
quality and density. On my density plots (for the density variable) there is 
are two peaks flanking the plot for average quality wine. The peak on the left, 
for lower density, is for the higher quality wine; and the peak on the right, 
for higher density, is for the lower quality wine.

<br>

******
# Final Plots and Summary

<br>

## Plot One

<br>

```{r final_plot1, warning=FALSE}

# create clean type variable for visualization
winesAll <- winesAll %>%
    mutate(cType = case_when(
        type == 'white'  ~ 'White Wine',
        type == 'red'    ~ 'Red Wine'
    ))

# factorize clean type variable
winesAll$cType <- factor(winesAll$cType, levels = c('White Wine', 'Red Wine'))

# create layered scatter and line plot
g1 <- ggplot(winesAll) +
    aes(
        x = quality_factor, 
        y = alcohol, 
        color = cType, group = 1
        ) +
    
    geom_jitter(
        position = position_jitter(height = 0.1, width = 0.5), 
        alpha = 0.3, 
        size = 0.5
        ) +
    
    geom_line(
        stat = 'summary', 
        fun = mean, 
        color = I('#005429'), 
        size = 0.75, 
        alpha = 0.9) +
    
    facet_wrap(~cType) +
    theme_gray() +
    
    theme(
        legend.position = 'none', 
        plot.title = element_text(size = 15L, face = 'bold', hjust = 0.5)
        ) +
    
    labs(
        x = 'Quality Score', 
        y = 'Alcohol by Volume', 
        title = 'Alcohol Content by Quality Score & Wine Type'
        )

# change color scale
g1 <- g1 + scale_color_aaas()

# output visualization
g1
rm(g1)

# remove clean type
winesAll <- winesAll %>% select(-cType)
```

This plot uses a scatter plot to chart alcohol content by quality score. 
Because quality is a factor, I decided to use jitter to spread out the data 
points; 
they otherwise would plot as a single line on each quality score.  
This plot also utilizes a line to represent the mean alcohol by volume for 
each quality score. 
Doing this helps visualize the trends.

<br>

## Plot Two

<br>

```{r final_plot2}

# create subset of just variables that will be tested
winesSubset <- winesAll %>% 
    select( c(quality, alcohol, volatile_acidity, chlorides, 
              density, sulphates, fixed_acidity, pH) )

# create correlation matrix
corrMat <- cor(winesSubset, method = 'spearman')

# create matrix of p-values
pValMat <- cor_pmat(winesSubset)


# define title
plotTitle <- 'Correlation Matrix of Wine Quality Variables'

# plot correlation matrix
ggcorrplot(corrMat,
           hc.order = TRUE, 
           outline.col = 'gray',
           type = 'lower',
           lab = TRUE,
           insig = 'blank',
           p.mat = pValMat,
           tl.srt = 45,
           show.legend = FALSE,
           title = plotTitle,
           ggtheme = ggplot2::theme_gray,
           colors = c('#3A8C89', 'white', '#E79C60')
           )

rm(winesSubset, corrMat, pValMat, plotTitle)
```

This plot is a cleaned-up correlation matrix that visualizes the relationships 
between key variables in this dataset. The cells show up blank when the 
p-value is larger than the significant level (0.05). 
These cells are insignificant, and can be removed from the visualization to 
reduce clutter.

<br>

## Plot Three

<br>

```{r final_plot3, warning=FALSE}
# create first plot - box
g1 <- ggplot(winesAll) +
    aes(
        x = quality_factor, 
        y = alcohol, 
        fill = quality_group
        ) +
    
    geom_boxplot(
        shape = 'circle', 
        alpha = 0.75
        ) +
    
    theme_gray() +
    
    theme(
        legend.position = 'none', 
        plot.title = element_text(size = 15L, face = 'bold', hjust = 0.5)
        ) +
    
    labs(
        x = 'Quality Score', 
        y = 'Alcohol by Volume', 
        title = 'Alcohol Content of Wine by Quality Score & Group'
        )

# create second plot - density
g2 <- ggplot(winesAll) +
    aes(
        x = alcohol, 
        fill = quality_group
        ) +
    
    geom_density(
        adjust = 0.8, 
        alpha = 0.5
        ) +
    
    theme_gray() +
    theme(legend.position = 'bottom') +
    
    labs(
        x = 'Alcohol by Volume',
        y = 'Density',
        fill = 'Quality Group'
        )

# change color scale
g1 <- g1 + scale_fill_aaas()
g2 <- g2 + scale_fill_aaas()

# combine plots into one visualization
grid.arrange(g1, g2)
rm(g1, g2)
```

This plot visualizes the relationship between alcohol content and 
quality score. 
In the upper chart, the individual quality scores are displayed as a boxplot. 
In the lower chart, the quality scores are grouped and displayed as a 
density plot.

<br>

******
# Reflection

After I combined the red wine and white wine datasets, there were about 6,500 
samples with a dozen variables to explore.  

I began by creating a summary and a combined histogram/density plot for each 
variable in the wines dataset. After observing some abnormal distributions in 
the first few plots, it quickly became apparent that many of the variables 
were not normally distributed. After discovering this, I went back and included 
additional plots for scale_x_log10 in my function before continuing my analysis. 
Adding the log10 scale helped move some variables to a more normal distribution, 
but not all of them. This dataset is relatively small, and I think that makes it 
difficult to reach normal distribution in some cases.  

Next, I created box plots so I could quickly visualize mean values, the 
distribution of each variable within the dataset, and any skewed data 
or outliers.  

In the bivariate plots section I employed correlation matrix plots and 
scatterplots to explore the relationship between variables. I was primarily 
focused on the relationship each variable had with quality. There were a few 
interesting correlations, but the strongest indicator of quality was 
alcohol content.  

After that, I narrowed my focus and used density plots to analyze the 
relationships between a few key variables and quality groups I created. Each of 
the groups (low, medium, high) had roughly the same number of observations in 
them, and using this methodology made it easier to visualize the positive 
correlation between alcohol and perceived quality.  

One serious limitation to this project is the quality score used as a key 
metric. Even though quality was meant to be on a scale of 0-10, 93% of the 
observations had an assigned quality score of 5, 6, or 7; and there were no 
observations with a quality score below 3 or above 9. Also, I discovered that 
using a categorical variable with only a few potential outcomes is good for 
grouping results, but terrible for using some more advanced plotting techniques, 
like scatterplots. I was able to overcome this somewhat by layering plots and 
leveraging geom_jitter, but it made the multivariate plots section of this 
research challenging.  

If I wanted to explore this dataset and these questions more in the future, 
I would seek out additional data. This project would have benefited from more 
observations - preferably many more. It also would benefit from additional 
numeric variables that are related to quality. I suspect price, or perceived 
price (if real price is hidden from the subjects during wine grading), plays a 
role in the quality metric - maybe price and alcohol content are correlated.  

Or perhaps the one-true indicator of quality in wine is alcohol content, and 
there’s nothing else to discover on this subject.

<br>

******